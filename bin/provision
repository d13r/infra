#!/usr/bin/env bash
set -euo pipefail
cd "$(dirname "$0")/../ansible"

hosts=${1-}
shift || true

if [[ $hosts = '--help' || $hosts = '-h' ]]; then
    echo "Usage: ${BIN_COMMAND-$0} HOST [ANSIBLE OPTIONS]"
    exit
fi

if [[ -z $hosts ]]; then
    # Current host (lowercased)
    hosts=${HOSTNAME,,}
fi

playbooks=()

IFS=','
for host in $hosts; do
    # Canonicalise the hostname to allow aliases/shortcuts
    host=$(ssh -G "$host" | awk '$1 == "hostname" {print $2; exit}')
    host=${host/.*}

    if [[ ! -f "provision-$host.yml" ]]; then
        echo "Host '$host' not recognised (check that ansible/provision-$host.yml exists)" 2>&1
        exit 1
    fi

    playbooks+=("provision-$host.yml")
done

exec ../bin/ansible-playbook "${playbooks[@]}" "$@"
