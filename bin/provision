#!/usr/bin/env bash
set -euo pipefail
cd "$(dirname "$0")/../ansible"

host=${1-}

if [[ $host = '' || $host = '--help' || $host = '-h' ]]; then
    echo "Usage: ${BIN_COMMAND-$0} HOST [ANSIBLE OPTIONS]"
    exit
fi

shift

if [[ ! -f "provision-$host.yml" ]]; then
    echo "Host not recognised (check that ansible/provision-$host.yml exists)" 2>&1
    exit 1
fi

args=()
if [[ $host = 'wsl' ]]; then
    if [[ -f ../.env ]]; then
        source ../.env
    fi
    if [[ -n ${WSL_SUDO_PASSWORD-} ]]; then
        export WSL_SUDO_PASSWORD
        args+=(-e ansible_become_password="{{ lookup('env', 'WSL_SUDO_PASSWORD') }}")
    else
        args+=(--ask-become-pass)
    fi
fi

exec ../bin/ansible-playbook "${args[@]}" "provision-$host.yml" "$@"
