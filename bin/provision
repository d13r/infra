#!/usr/bin/env bash
set -euo pipefail
cd "$(dirname "$0")/../ansible"

host=${1-}

if [[ $host = '--help' || $host = '-h' ]]; then
    echo "Usage: ${BIN_COMMAND-$0} HOST [ANSIBLE OPTIONS]"
    exit
fi

if [[ -z $host ]]; then
    # Current host (lowercased)
    host=${HOSTNAME,,}
else
    # Canonicalise the hostname to allow aliases/shortcuts
    host=$(ssh -G "$host" | awk '$1 == "hostname" {print $2; exit}')
    host=${host/.*}
fi

shift || true

if [[ ! -f "provision-$host.yml" ]]; then
    echo "Host not recognised (check that ansible/provision-$host.yml exists)" 2>&1
    exit 1
fi

exec ../bin/ansible-playbook "provision-$host.yml" "$@"
